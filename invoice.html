<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

  <title>Product Master</title>
  <link rel="stylesheet" href="header.css">
  <link rel="stylesheet" href="styles.scss">
</head>
<body>
    <header class="header">
        <div class="menu-icon" onclick="toggleMenu()">☰</div>
        <div class="user-menu">
            <div class="user-menu">
                <div class="user-icon">&#128100;</div>
                <span id="usernamePlaceholder"></span>
                <div class="logout"><a href="#" id="logoutLink">Logout</a></div>
            </div>
        </div>
        <div class="menu-options" id="menuOptions">
            <a href="welcome.html">Home</a>
            <a href="#">About</a>
            <a href="product_master.html">Product Master</a>
            <a href="uom_master.html">UOM Master</a>
            <a href="invoice.html">Invoice</a>
            <a href="blog.html">Blog</a>
            <a href="#">Contact</a>
            <!-- Add more options as needed -->
        </div>
    </header>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="header.js"></script>
    <script>
        // Call the initializeHeader function when the document is ready
        $(document).ready(function () {
            initializeHeader();
        });


        // header.js

function toggleMenu() {
    var menuOptions = document.getElementById('menuOptions');
    var menuIcon = document.querySelector('.menu-icon');

    if (menuOptions.style.display === 'block') {
        menuOptions.style.display = 'none';
        menuIcon.innerHTML = '☰';
    } else {
        menuOptions.style.display = 'block';
        menuIcon.innerHTML = '✖';
    }
}

function initializeHeader() {
    var storedUsername = localStorage.getItem('username');
    if (storedUsername) {
        document.getElementById('usernamePlaceholder').textContent = storedUsername;
    } else {
        document.getElementById('usernamePlaceholder').textContent = 'Guest';
    }

    $('#logoutLink').on('click', function (e) {
        e.preventDefault();

        // Ask for confirmation
        var confirmLogout = confirm("Are you sure you want to logout?");
        if (!confirmLogout) {
            return;
        }

        localStorage.removeItem('username');

        $.ajax({
            type: 'GET',
            url: 'logout_process.php',
            success: function (response) {
                if (response === 'success') {
                    window.location.href = 'login.html';
                } else {
                    alert('Logout failed. Please try again.');
                }
            },
            error: function () {
                alert('Error occurred during logout process');
            }
        });
    });
}
</script>
<!--Page body-->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <button type="button" class="btn btn-success" id="saveButton">Save</button>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="#" id="refreshButton">Refresh</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <form id="invoiceForm">
        <div class="row">
            <!-- Left column -->
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="invoiceNumber" class="form-label">Invoice Number <span class="required-field">*</span></label>
                    <input type="text" class="form-control" id="invoiceNumber" name="invoiceNumber" placeholder="Enter Invoice Number" style="width: 250px;" required>
                    <div class="error-message" id="invoiceNumberError"></div>
                </div>
                
                <div class="mb-3">
                    <label for="invoiceDate" class="form-label">Invoice Date <span class="required-field">*</span></label>
                    <input type="date" class="form-control" id="invoiceDate" style="width: 250px;" required>
                    <div class="error-message" id="invoiceDateError"></div>
                </div>
            </div>
            <!-- Right column -->
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="customerName" class="form-label">Customer Name <span class="required-field">*</span></label>
                    <input type="text" class="form-control" id="customerName" placeholder="Enter Customer Name" style="width: 250px;" required>
                    <div class="error-message" id="customerNameError"></div>
                </div>
                
                <div class="mb-3">
                    <label for="mobileNumber" class="form-label">Mobile Number <span class="required-field">*</span></label>
                    <input type="tel" class="form-control" id="mobileNumber" placeholder="Enter Mobile Number" style="width: 250px;" pattern="[0-9]{10}" title="Please enter a valid 10-digit mobile number" required>
                    <div class="error-message" id="mobileNumberError"></div>
                </div>                
            </div>
        </div>
        <!-- Add more fields as needed -->
        <!-- Table Section -->
        <table class="table">
            <thead>
                <tr>
                    <th scope="col">SL.no</th>
                    <th scope="col">product_code</th>
                    <th scope="col">product_name</th>
                    <th scope="col">UOM</th>
                    <th scope="col">stock</th>
                    <th scope="col">selling_price</th>
                    <th scope="col">offer_price</th>
                    <th scope="col">Total</th>
                    <th scope="col">Action</th>
                </tr>
            </thead>
            <tbody>
                <!-- Add rows for your data here -->
                <tr>
                    <td>1</td>
                    <td><input type="text" class="form-control product-code-input" name="product_code[]" id="productCodeInput" autocomplete="off" /></td>
                    <td>
                        <select class="form-control product-dropdown" name="product_name[]">
                            <!-- Options will be dynamically added here -->
                        </select>
                    </td>
                    <td><input type="text" class="form-control uom-input" name="UOM[]" /></td>
                    <td><input type="number" class="form-control qty" name="stock[]" id="stock" /></td>
                    <td><input type="number" class="form-control selling-price" name="selling_price[]" /></td>
                    <td><input type="number" class="form-control offer-price" name="offer_price[]" /></td>
                    <td><input type="text" class="form-control total" name="total[]" readonly /></td>
                    <td><button type="button" class="btn btn-danger remove-row">Remove</button></td>
                </tr>
                <!-- Add more rows as needed -->
            </tbody>
        </table>
        <!-- Add a button to add new rows dynamically if required -->
        <button type="button" class="btn btn-primary" id="addRow">Add Row</button>
<!-- Net Total Section -->
<div id="netTotalContainer" class="mb-3">
    <div class="row">
        <div class="col-md-6 text-end">
            <label for="netTotal" id="netTotal" class="form-label">Net Total:</label>
        </div>
        <div class="col-md-6">
            <input type="text" id="netTotalInput" class="form-control" readonly style="width: 250px;">
        </div>
    </div>
</div>
<style>
/* Add this style in your CSS file */
#netTotalContainer {
    text-align: center; /* Center align the content */
}
#netTotal {
    margin-top: 5px; /* Adjust the margin based on your layout */
    font-size: 18px; /* Adjust the font size as needed for readability */
    font-weight: bold; /* Make the text bold for emphasis */
    margin-left: 10px; /* Add some spacing between the label and input */
}
#netTotalInput.form-control {
    width: 250px; /* Adjust the width based on your layout */
    font-size: 16px; /* Adjust the font size as needed for readability */
}
</style>

<!-- jQuery library -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<!-- jQuery UI library -->
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/themes/smoothness/jquery-ui.css">
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>

<!-- Fetch product names and initialize autocomplete -->
<!-- Fetch product names and initialize autocomplete -->
<script>

$(document).ready(function () {
    // ...
    

    // Function to fetch product names and populate the dropdown list
    function fetchProductNames(dropdown) {
        $.ajax({
            type: 'GET',
            url: 'get_products.php',
            success: function (response) {
                var productNames = response.map(function (product) {
                    return product.product_name;
                });

                dropdown.empty();
                dropdown.append($('<option>').text('Select Product').attr('value', ''));

                $.each(productNames, function (index, productName) {
                    dropdown.append($('<option>').text(productName).attr('value', productName));
                });
            },
            error: function () {
                alert('Error fetching product names');
            }
        });
    }

    // Call the fetchProductNames function to populate the initial dropdown list
    fetchProductNames($('.product-dropdown'));

 // Event handler for product dropdown change
$('table').on('change', '.product-dropdown', function () {
    var selectedProduct = $(this).val();
    var sellingPriceInput = $(this).closest('tr').find('.selling-price');
    var offerPriceInput = $(this).closest('tr').find('.offer-price');
    var uomInput = $(this).closest('tr').find('.uom-input');
    var productCodeInput = $(this).closest('tr').find('.product-code-input');

    // Fetch selling_price, offer_price, UOM, and product_code for the selected product
    $.ajax({
        type: 'GET',
        url: 'get_product_prices.php',
        data: { product_name: selectedProduct },
        success: function (response) {
            // Assuming the response is an object with the required properties
            var sellingPrice = response.selling_price;
            var offerPrice = response.offer_price;
            var uom = response.UOM;
            var productCode = response.product_code;

            // Update the corresponding input fields with the fetched values
            sellingPriceInput.val(sellingPrice);
            offerPriceInput.val(offerPrice);
            uomInput.val(uom);
            productCodeInput.val(productCode);
        },
        error: function () {
            alert('Error fetching product prices');
        }
    });
});



// Event handler for stock quantity change
$('table').on('input', '.qty', function () {
    var quantity = parseInt($(this).val()) || 0;
    var sellingPrice = parseFloat($(this).closest('tr').find('.selling-price').val()) || 0;
    var existingOfferPrice = parseFloat($(this).closest('tr').find('.offer-price').val()) || 0;

    // Calculate the updated offer price based on quantity and existing offer price
    var updatedOfferPrice = quantity * existingOfferPrice;
    $(this).closest('tr').find('.offer-price').val(updatedOfferPrice.toFixed(2));

    // Calculate the updated selling price based on quantity and update the selling price input field
    var updatedSellingPrice = calculateUpdatedSellingPrice(quantity, sellingPrice);
    $(this).closest('tr').find('.selling-price').val(updatedSellingPrice.toFixed(2));
});

// Function to calculate the updated selling price based on quantity (replace this with your logic)
function calculateUpdatedSellingPrice(quantity, originalSellingPrice) {
    // Replace this with your logic to calculate the updated selling price based on quantity and original selling price
    // For example, you can double the selling price when the quantity is increased
    var updatedSellingPrice = quantity * originalSellingPrice;

    return updatedSellingPrice;
}


// Event handler for product code input change
$('table').on('input', '.product-code-input', function () {
    var productCode = $(this).val();
    var row = $(this).closest('tr');

    // Fetch product details based on the entered product code
    $.ajax({
        type: 'GET',
        url: 'get_product_details.php',
        data: { product_code: productCode },
        success: function (response) {
            // Assuming the response is an object with the required properties
            var productName = response.product_name;
            var uom = response.UOM;
            var sellingPrice = response.selling_price;
            var offerPrice = response.offer_price;

            // Update the corresponding input fields with the fetched values
            row.find('.product-dropdown').val(productName);
            row.find('.uom-input').val(uom);
            row.find('.selling-price').val(sellingPrice);
            row.find('.offer-price').val(offerPrice);
        },
        error: function () {
            alert('Error fetching product details');
        }
    });
});




    // Initialize Autocomplete for the product code input
    $('.product-code-input').autocomplete({
        source: function (request, response) {
            // Fetch product codes from the server
            $.ajax({
                type: 'GET',
                url: 'get_product_codes.php', // Create a new PHP file to handle product code fetching
                data: {
                    search: request.term
                },
                success: function (data) {
                    // Map the response data to an array of product codes
                    var productCodes = data.map(function (product) {
                        return product.product_code;
                    });
                    response(productCodes);
                },
                error: function () {
                    alert('Error fetching product codes');
                }
            });
        },
        select: function (event, ui) {
            // When a product code is selected, fetch and populate other details
            var selectedProductCode = ui.item.value;
            var row = $(this).closest('tr');

            // Fetch product details based on the selected product code
            $.ajax({
                type: 'GET',
                url: 'get_product_details.php',
                data: {
                    product_code: selectedProductCode
                },
                success: function (response) {
                    // Assuming the response is an object with the required properties
                    var productName = response.product_name;
                    var uom = response.UOM;
                    var sellingPrice = response.selling_price;
                    var offerPrice = response.offer_price;

                    // Update the corresponding input fields with the fetched values
                    row.find('.product-dropdown').val(productName);
                    row.find('.uom-input').val(uom);
                    row.find('.selling-price').val(sellingPrice);
                    row.find('.offer-price').val(offerPrice);
                },
                error: function () {
                    alert('Error fetching product details');
                }
            });
        }
    });

    function initializeProductCodeAutocomplete(row) {
    row.find('.product-code-input').autocomplete({
        source: function (request, response) {
            // Fetch product codes from the server
            $.ajax({
                type: 'GET',
                url: 'get_product_codes.php',
                data: {
                    search: request.term
                },
                success: function (data) {
                    // Map the response data to an array of product codes
                    var productCodes = data.map(function (product) {
                        return product.product_code;
                    });
                    response(productCodes);
                },
                error: function () {
                    alert('Error fetching product codes');
                }
            });
        }
    });
}

// Call this function when the document is ready to initialize the Autocomplete for the first row
initializeProductCodeAutocomplete($('table tbody tr:first'));


    // Event handler for "Add Row" button click
    $('#addRow').on('click', function () {
        // Clone the last row of the table
        var newRow = $('table tbody tr:last').clone();

        // Clear the input values in the cloned row
        newRow.find('input').val('');

        // Increment the SL.no in the cloned row
        var lastSlNo = parseInt(newRow.find('td:first').text());
        newRow.find('td:first').text(lastSlNo + 1);

        // Append the cloned row to the table
        $('table tbody').append(newRow);

        // Fetch product names and populate the new dropdown
        fetchProductNames(newRow.find('.product-dropdown'));
    });

    // Your other scripts

        // Event handler for "Remove" button click
        $('table').on('click', '.remove-row', function () {
        // Find the closest row and remove it
        $(this).closest('tr').remove();

        // After removing the row, update the totals
        updateTotals();
    });


        // Function to calculate the total for a row based on the offer price
        function calculateRowTotal(row) {
            var quantity = parseInt(row.find('.qty').val()) || 0;
            var offerPrice = parseFloat(row.find('.offer-price').val()) || 0;
            return quantity * offerPrice;
        }
    
        // Function to update the total and net total
        function updateTotals() {
            var netTotal = 0;
    
            // Iterate through each row in the table
            $('table tbody tr').each(function () {
                var row = $(this);
                var total = calculateRowTotal(row);
    
                // Update the total for the current row
                row.find('.total').val(total.toFixed(2));
    
                // Accumulate the total for the net total calculation
                netTotal += total;
            });
    
            // Update the net total input field
            $('#netTotalInput').val(netTotal.toFixed(2));
        }
    
        // Event handler for quantity and offer price changes
        $('table').on('input', '.qty, .offer-price', function () {
            updateTotals();
        });
    
        // Event handler for "Add Row" button click
        $('#addRow').on('click', function () {
            // ... (existing code)
    
            // Fetch product names and populate the new dropdown
            fetchProductNames(newRow.find('.product-dropdown'));
    
            // Update totals when a new row is added
            updateTotals();
        });
    


   // Event handler for "Save" button click
   $('#saveButton').on('click', function () {
    var rowsData = [];

    // Iterate through each row in the table
    $('table tbody tr').each(function () {
        var row = $(this);
        var rowData = {
            invoiceNo: $('#invoiceNumber').val(),
            invoiceDate: $('#invoiceDate').val(),
            customerName: $('#customerName').val(),
            mobileNo: $('#mobileNumber').val(),
            qty: row.find('.qty').val(),
            netTotal: row.find('.total').val(),
            savedBy: localStorage.getItem('username'),
            savedDateTime: getCurrentDateTime(),
            productCode: row.find('.product-code-input').val()
        };

        rowsData.push(rowData);
    });

    $.ajax({
        type: 'POST',
        url: 'save_invoice.php',
        data: {
            invoiceData: JSON.stringify(rowsData)
        },
        success: function (response) {
            if (response === 'success') {
                alert('Data saved successfully!');
                // Optionally, you can reload the page or perform other actions
                location.reload();
            } else {
                alert('Data saved successfully!');
            }
        },
        error: function () {
            alert('Error occurred while saving data');
        }
    });

    
});




    // Event handler for "Refresh" button click
$('#refreshButton').on('click', function () {
    // Reset the values of all textboxes in the form
    $(':input', '#invoiceForm')
        .not(':button, :submit, :reset, :hidden')
        .val('')
        .prop('checked', false)
        .prop('selected', false);

    // Reset the SL.no in the table
    $('table tbody tr').each(function (index) {
        $(this).find('td:first').text(index + 1);
    });

    // Fetch product names and populate the dropdowns
    $('table tbody tr').each(function () {
        fetchProductNames($(this).find('.product-dropdown'));
    });

    // Fetch UOM codes and populate the dropdowns
    fetchUOMCodes($('.uom-code-dropdown'));

    // Update totals after resetting
    updateTotals();
});

});

// Function to get the current date and time in a desired format
function getCurrentDateTime() {
    var currentDate = new Date();
    var formattedDate = currentDate.toISOString().slice(0, 19).replace("T", " "); // Format: YYYY-MM-DD HH:mm:ss
    return formattedDate;
}


var mobileNumberInput = $('#mobileNumber');
var mobileNumberError = $('#mobileNumberError');
var offerPriceInputs = $('.offer-price');
var sellingPriceInputs = $('.selling-price');

mobileNumberInput.on('blur', function () {
    validateMobileNumber($(this).val());
});

offerPriceInputs.on('blur', function () {
    validateNumericValue($(this), 'Offer Price');
});

sellingPriceInputs.on('blur', function () {
    validateNumericValue($(this), 'Selling Price');
});

// Modify the validateMobileNumber function to update the error message div
function validateMobileNumber(mobileNumber) {
    var mobileNumberRegex = /^[0-9]{10}$/;
    var errorDiv = $('#mobileNumberError');

    if (mobileNumberRegex.test(mobileNumber)) {
        // Valid mobile number
        errorDiv.text(''); // Clear the error message
        errorDiv.removeClass('error-text');
    } else {
        // Invalid mobile number
        errorDiv.text('Please enter a valid 10-digit mobile number');
        errorDiv.addClass('error-text');
    }
}

// Modify the validateNumericValue function to update the error message div
function validateNumericValue(inputElement, fieldName) {
    var numericValue = inputElement.val();
    var numericRegex = /^-?\d*\.?\d*$/; // Regex for numeric values
    var errorDiv = inputElement.closest('.mb-3').find('.error-message');

    if (numericRegex.test(numericValue)) {
        // Valid numeric value
        errorDiv.text(''); // Clear the error message
        errorDiv.removeClass('error-text');
    } else {
        // Invalid numeric value
        errorDiv.text(fieldName + ' must be a valid number');
        errorDiv.addClass('error-text');
    }
}

// Call the toggleStarMarks and toggleErrorMessages functions on input focus
$('input[required]').on('focus', function () {
    toggleStarMarks();
    toggleErrorMessages();
});

// Call the toggleStarMarks and toggleErrorMessages functions on input change
$('input[required]').on('input', function () {
    toggleStarMarks();
    toggleErrorMessages();
});

// Call the toggleErrorMessages function when the document is ready
$(document).ready(function () {
    toggleStarMarks();
    toggleErrorMessages();
});

// Add a function to toggle error messages based on input validity
function toggleErrorMessages() {
    $('input[required]').each(function () {
        var errorDiv = $(this).closest('.mb-3').find('.error-message');
        errorDiv.toggle(!this.validity.valid || $(this).is(':focus'));
    });
}


// Function to validate numeric values for offer price and selling price
function validateNumericValue(inputElement, fieldName) {
    var numericValue = inputElement.val();
    var numericRegex = /^-?\d*\.?\d*$/; // Regex for numeric values

    if (numericRegex.test(numericValue)) {
        // Valid numeric value
        inputElement.next('.error-message').text(''); // Clear the error message
        inputElement.next('.error-message').removeClass('error-text');
    } else {
        // Invalid numeric value
        inputElement.next('.error-message').text(fieldName + ' must be a valid number');
        inputElement.next('.error-message').addClass('error-text');
    }
}


    </script>
    
<style>
    .error-message {
    color: red;
    font-size: 12px;
    margin-top: 5px;
}

.error-text {
    display: block;
}

.required-field {
    color: red;
}

</style>

</body>
</html>